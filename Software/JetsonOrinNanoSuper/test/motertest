import time
from pymavlink import mavutil

# μ ―μ¨ μ¤λ¦° λ‚λ…Έμ UART ν¬νΈμ— μ—°κ²°
master = mavutil.mavlink_connection('/dev/ttyTHS0', baud=921600)

# μ—°κ²° ν™•μΈ
master.wait_heartbeat()
print("FCμ™€ μ—°κ²°λμ—μµλ‹λ‹¤ (Heartbeat: %u, System: %u)" % (master.target_system, master.target_component))

def run_motor_test(motor_number, throttle_percent, duration_sec):
    """
    μ§€μ •λ λ¨ν„°λ¥Ό νΉμ • μ¶λ ¥μΌλ΅ μ£Όμ–΄μ§„ μ‹κ°„ λ™μ• ν…μ¤νΈν•©λ‹λ‹¤.

    Args:
        motor_number (int): ν…μ¤νΈν•  λ¨ν„° λ²νΈ (1λ¶€ν„° μ‹μ‘)
        throttle_percent (int): μ¤λ΅ν‹€ μ¶λ ¥ (%, 5-10% μ •λ„κ°€ μ•μ „)
        duration_sec (int): ν…μ¤νΈ μ§€μ† μ‹κ°„ (μ΄)
    """
    print(f"ν…μ¤νΈ μ‹μ‘: λ¨ν„° #{motor_number}, μ¶λ ¥: {throttle_percent}%, μ‹κ°„: {duration_sec}μ΄")
    master.mav.command_long_send(
        master.target_system,
        master.target_component,
        mavutil.mavlink.MAV_CMD_DO_MOTOR_TEST,
        0, # ν™•μΈ λ©”μ‹μ§€
        motor_number,       # param 1: λ¨ν„° μμ„ (1-4)
        mavutil.mavlink.MOTOR_TEST_THROTTLE_PERCENT, # param 2: μ¤λ΅ν‹€ νƒ€μ…
        throttle_percent,   # param 3: μ¤λ΅ν‹€ κ°’
        duration_sec,       # param 4: ν…μ¤νΈ μ‹κ°„ (μ΄)
        0,                  # param 5: μ‚¬μ© μ• ν•¨
        0,                  # param 6: μ‚¬μ© μ• ν•¨
        0)                  # param 7: μ‚¬μ© μ• ν•¨

    # FCκ°€ λ…λ Ήμ„ μλ½ν–λ”μ§€ ν™•μΈ
    ack = master.recv_match(type='COMMAND_ACK', blocking=True, timeout=duration_sec + 1)
    if ack and ack.command == mavutil.mavlink.MAV_CMD_DO_MOTOR_TEST and ack.result == mavutil.mavlink.MAV_RESULT_ACCEPTED:
        print(f"λ¨ν„° #{motor_number} ν…μ¤νΈ λ…λ Ή μλ½λ¨.")
    else:
        print(f"λ¨ν„° #{motor_number} ν…μ¤νΈ λ…λ Ή μ‹¤ν¨ λλ” νƒ€μ„μ•„μ›ƒ. ACK: {ack}")


# --- λ©”μΈ μ‹¤ν–‰ ---
if __name__ == "__main__":
    # π¨ ν”„λ΅ν λ¬κ°€ μ κ±°λμ—λ”μ§€ λ°λ“μ‹ ν™•μΈν•μ„Έμ”!

    # 1λ²λ¶€ν„° 4λ² λ¨ν„°κΉμ§€ μμ„λ€λ΅ ν…μ¤νΈ
    for i in range(1, 5):
        # 5% μ¶λ ¥μΌλ΅ 2μ΄κ°„ ν…μ¤νΈ
        run_motor_test(motor_number=i, throttle_percent=20, duration_sec=10)

        # λ‹¤μ λ¨ν„° ν…μ¤νΈ μ „ 3μ΄κ°„ λ€κΈ°
        time.sleep(3)

    print("λ¨λ“  λ¨ν„° ν…μ¤νΈ μ™„λ£.")
