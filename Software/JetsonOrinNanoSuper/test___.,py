from ultralytics import YOLO
import cv2
import cv2.aruco as aruco

# YOLO ëª¨ë¸ ë¡œë”©
model = YOLO("best.pt")

# ì¹´ë©”ë¼ ì—´ê¸°
cap = cv2.VideoCapture(0)
if not cap.isOpened():
    print("ì¹´ë©”ë¼ ì—´ê¸° ì‹¤íŒ¨")
    exit()

# í™”ë©´ í¬ê¸°
frame_width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
frame_height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
w1, w2 = frame_width // 3, 2 * frame_width // 3
h1, h2 = frame_height // 3, 2 * frame_height // 3

# YOLO í´ë˜ìŠ¤ ì´ë¦„
class_names = model.names

# ArUco ë§ˆì»¤ ë”•ì…”ë„ˆë¦¬ ì„¤ì •
aruco_dict = aruco.getPredefinedDictionary(aruco.DICT_4X4_50)
parameters = aruco.DetectorParameters()

# ìœ„ì¹˜ ë ˆì´ë¸” í•¨ìˆ˜
def get_position_label(x, y):
    if y < h1:
        vertical = "ìœ„"
    elif y < h2:
        vertical = "ê°€ìš´ë°"
    else:
        vertical = "ì•„ë˜"

    if x < w1:
        horizontal = "ì™¼ìª½"
    elif x < w2:
        horizontal = "ê°€ìš´ë°"
    else:
        horizontal = "ì˜¤ë¥¸ìª½"

    return f"{vertical}-{horizontal}"

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # YOLO ì¶”ë¡ 
    results = model.predict(frame, imgsz=640, conf=0.5, verbose=False)
    annotated_frame = results[0].plot()

    # YOLO ë°•ìŠ¤ ì²˜ë¦¬
    for box in results[0].boxes:
        cls_id = int(box.cls[0])
        class_name = class_names[cls_id]
        x1, y1, x2, y2 = box.xyxy[0]
        center_x = int((x1 + x2) / 2)
        center_y = int((y1 + y2) / 2)

        label = get_position_label(center_x, center_y)
        print(f"ğŸ”¥ {class_name}: {label}")

        # ì‹œê°í™”
        cv2.circle(annotated_frame, (center_x, center_y), 5, (0, 0, 255), -1)
        cv2.putText(annotated_frame, f"{class_name}: {label}", (center_x, center_y - 10),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 0, 0), 2)

    # ArUco ë§ˆì»¤ íƒì§€
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    detector = aruco.ArucoDetector(aruco_dict, parameters)
    corners, ids, _ = detector.detectMarkers(gray)

    if ids is not None:
        for i, corner in enumerate(corners):
            # ë§ˆì»¤ ì¤‘ì‹¬ ê³„ì‚°
            corner_points = corner[0]
            cx = int(corner_points[:, 0].mean())
            cy = int(corner_points[:, 1].mean())

            label = get_position_label(cx, cy)
            print(f"ğŸ›¬ ArUco ID {ids[i][0]}: {label}")

            # ë§ˆì»¤ ì‹œê°í™”
            cv2.polylines(annotated_frame, [corner_points.astype(int)], True, (0, 255, 0), 2)
            cv2.circle(annotated_frame, (cx, cy), 5, (0, 255, 0), -1)
            cv2.putText(annotated_frame, f"ID:{ids[i][0]} {label}", (cx, cy - 10),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)

    # ê²°ê³¼ í‘œì‹œ
    cv2.imshow("YOLO + ArUco Detection", annotated_frame)

    if cv2.waitKey(1) & 0xFF == 27:
        break

cap.release()
cv2.destroyAllWindows()
